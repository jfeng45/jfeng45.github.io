<!doctype html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="清晰架构（Clean Atchitecture）的Go微服务: 依赖注入（Dependency Injection）" />
<meta property="og:description" content="程序容器使用依赖注入创建具体类型并将它们注入每个函数。 在它内部使用工厂方法模式。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jfeng45.github.io/posts/dependency_injection/" />
<meta property="article:published_time" content="2019-07-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-07-29T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="清晰架构（Clean Atchitecture）的Go微服务: 依赖注入（Dependency Injection）"/>
<meta name="twitter:description" content="程序容器使用依赖注入创建具体类型并将它们注入每个函数。 在它内部使用工厂方法模式。"/>



    
      <link rel="canonical" href="https://jfeng45.github.io/posts/dependency_injection/">
    

    
       <meta name="description" content="程序容器使用依赖注入创建具体类型并将它们注入每个函数。 在它内部使用工厂方法模式。">
    

    <title>
      
        清晰架构（Clean Atchitecture）的Go微服务: 依赖注入（Dependency Injection） | 
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://jfeng45.github.iocss/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
  <div id="container">
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="/">
            
码农工匠
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/introduction">首页</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/posts">文章</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/project/">项目</a>
                    
                </li>
                
            </ul>
            
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        语言
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                        
                            <a class="dropdown-item" href="https://jfeng45.github.io/en/">English</a>
                        
                            <a class="dropdown-item" href="https://jfeng45.github.io/">中文</a>
                        
                    </div>
                </li>
            </ul>
            
        </div>
    </nav>
</header>

    
    <div id="body">
      
      <div class="container">
        <div class="row">
          <div class="col-12 col-lg-8 blog-main">

            

<header>
    <h5 class="blog-post-title">
    <a class="text-dark" href="/posts/dependency_injection/">清晰架构（Clean Atchitecture）的Go微服务: 依赖注入（Dependency Injection）</a>
</h5>

    


<div class="blog-post-date text-secondary">
    
        <time datetime="2019-07-29">2019-07-29</time>
    
    
       <span rel="author">冯进</span>
    
</div>

    
<div class="blog-post-tags text-secondary">
    <strong>标签:</strong>
    
        <a class="badge badge-primary" href="/tags/golang">Golang</a>
    
        <a class="badge badge-primary" href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5">依赖注入</a>
    
        <a class="badge badge-primary" href="/tags/%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%84">清晰架构</a>
    
        <a class="badge badge-primary" href="/tags/%E7%A8%8B%E5%BA%8F%E5%AE%B9%E5%99%A8">程序容器</a>
    
</div>

    
<div class="blog-post-categories text-secondary">
    <strong>分类:</strong>
    
        <a class="badge badge-primary" href="/categories/go%E5%BE%AE%E6%9C%8D%E5%8A%A1">Go微服务</a>
    
</div>

    <hr>
</header>
<article class="blog-post">
    

<p>在清晰架构（Clean Atchitecture）中，应用程序的每一层（用例，数据服务和域模型）仅依赖于其他层的接口而不是具体类型。 在运行时，<a href="https://jfeng45.github.io/posts/application_container/">程序容器</a>¹负责创建具体类型并将它们注入到每个函数中，它使用的技术称为<a href="https://www.martinfowler.com/articles/injection.html#FormsOfDependencyInjection">依赖注入</a>²。 以下是要求。</p>

<p><strong>容器包的依赖关系:</strong></p>

<ol>
<li><p>容器包是唯一依赖于具体类型和许多外部库的包，因为它需要创建具体类型。 本程序中的所有其他软件包主要仅依赖于接口。</p></li>

<li><p>外部库可以包括DB和DB连接，gRPC连接，HTTP连接，SMTP服务器，MQ等。</p></li>

<li><p>＃2中提到的具体类型的资源链接只需要创建一次并放入注册表中，所有后来的请求都将从注册表中检索它们。</p></li>

<li><p>只有用例层需要访问并依赖于容器包。</p></li>
</ol>

<p>依赖注入的核心是工厂方法模式(factory method pattern)。</p>

<h5 id="工厂方法模式-factory-method-pattern"><strong>工厂方法模式（Factory Method Pattern）:</strong></h5>

<p><br/></p>

<p>实现工厂方法模式并不困难，<a href="https://stackoverflow.com/a/49714445">这里</a>³描述了是如何在Go中实现它的。困难的部分是使其可扩展，即如何避免在添加新工厂时修改代码。</p>

<p>处理新工厂的方式有很多种，下面是常见的三种：</p>

<ul>
<li><p>(1)<a href="https://stackoverflow.com/questions/3434466/creating-a-factory-method-in-java-that-doesnt-rely-on-if-else">使用if-else语句</a>⁴</p></li>

<li><p>(2) <a href="https://stackoverflow.com/questions/3434466/creating-a-factory-method-in-java-that-doesnt-rely-on-if-else/3434505#3434505">使用映射（map）保存不同的工厂</a>⁵</p></li>

<li><p>(3) 使用反射生成新的具体类型。</p></li>
</ul>

<p>＃1不是一个好选择，因为你需要在添加新类型时修改现有代码。 ＃3是最好的，因为添加新工厂时现有代码不需更改。在Java中，我会使用＃3，因为Java具有非常优雅的反射实现。你可以执行类似“（Animal）Class.forName（”className“）。newInstance（）”的操作，即你可以将类的名称作为函数中的字符串参数传递进来，并通过反射从中创建一个类型的新实例，然后将结构转换为适当的类型（可能是它的一个超级类型（super type），这是非常强大的。由于Go的反射不如Java，＃3不是一个好选择。在Go中，由反射创建的实例是反射类型而不是实际类型，并且你无法在反射类型和实际类型之间转换类型，它们处于两个不同的世界中，这使得Go中的反射难以使用。所以我选择＃2，它比＃1好，但是在添加新类型时需要更改少部分代码。</p>

<p>以下是数据存储工厂的代码。它有一个“dsFbInterface”，其中有一个“Build”函数需要由每个数据存储工厂实现。 “Build”是工厂的关键部分。 “dsFbMap”是每个数据库（或gRPC）的代码（code）与实际工厂之间的映射。这是添加数据库时需要更改的部分。</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// To map &#34;database code&#34; to &#34;database interface builder&#34;
</span><span style="color:#75715e">// Concreate builder is in corresponding factory file. For example, &#34;sqlFactory&#34; is in &#34;sqlFactory&#34;.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">dsFbMap</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">dsFbInterface</span>{
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SQLDB</span>:      <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sqlFactory</span>{},
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">COUCHDB</span>:    <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">couchdbFactory</span>{},
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">CACHE_GRPC</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cacheGrpcFactory</span>{},
}

<span style="color:#75715e">// DataStoreInterface serve as a marker to indicate the return type for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DataStoreInterface</span> <span style="color:#66d9ef">interface</span>{}

<span style="color:#75715e">// The builder interface for factory method pattern
</span><span style="color:#75715e">// Every factory needs to implement Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">dsFbInterface</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DataStoreConfig</span>) (<span style="color:#a6e22e">DataStoreInterface</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">//GetDataStoreFb is accessors for factoryBuilderMap
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetDataStoreFb</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">dsFbInterface</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dsFbMap</span>[<span style="color:#a6e22e">key</span>]
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p>以下是“sqlFactory”的程序，它实现了上面的代码中定义的“dsFbInterface”。 它为MySql数据库创建数据存储。 在“Build”函数中，它首先从注册表中检索数据存储（MySql），如果找到，则返回，否则创建一个新的并将其放入注册表。
因为注册表可以存储任何类型的数据，所以我们需要在检索后将返回值转换为适当的类型（*sql.DB）。 “databasehandler.SqlDBTx”是实现“SqlGdbc”接口的具体类型。 它的创建是为了支持事务管理。 代码中调用“sql.Open（）”来打开数据库连接，但它并没有真正执行任何连接数据库的操作。 因此，需调用“db.Ping（）”去访问数据库以确保数据库正在运行。</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// sqlFactory is receiver for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">sqlFactory</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#75715e">// implement Build method for SQL database
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sqlFactory</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">dsc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DataStoreConfig</span>) (<span style="color:#a6e22e">DataStoreInterface</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">Code</span>
	<span style="color:#75715e">//if it is already in container, return
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">found</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">key</span>); <span style="color:#a6e22e">found</span> {
		<span style="color:#a6e22e">sdb</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">value</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">DB</span>)
		<span style="color:#a6e22e">sdt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">databasehandler</span>.<span style="color:#a6e22e">SqlDBTx</span>{<span style="color:#a6e22e">DB</span>: <span style="color:#a6e22e">sdb</span>}
		<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Log</span>.<span style="color:#a6e22e">Debug</span>(<span style="color:#e6db74">&#34;found db in container for key:&#34;</span>, <span style="color:#a6e22e">key</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sdt</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#a6e22e">db</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">DriverName</span>, <span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">UrlAddress</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	}
	<span style="color:#75715e">// check the connection
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">Ping</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	}
	<span style="color:#a6e22e">dt</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">databasehandler</span>.<span style="color:#a6e22e">SqlDBTx</span>{<span style="color:#a6e22e">DB</span>: <span style="color:#a6e22e">db</span>}
	<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">db</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">dt</span>, <span style="color:#66d9ef">nil</span>

}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<h5 id="数据服务工厂-data-service-factory"><strong>数据服务工厂（Data service factory）</strong></h5>

<p><br/></p>

<p>数据服务层使用工厂方法模式来创建数据服务类型。 可以有不同的策略来应用此模式。 在构建数据服务工厂时，我使用了三种不同的策略，每种策略都有其优缺点。 我将详细解释它们，以便你可以决定在那种情况下使用哪一个。</p>

<p><strong>基础工厂（Basic factory）</strong></p>

<p>最简单的是“cacheGrpcFactory”，因为数据存储只有一个底层实现（即gRPC），所以只创建一个工厂就行了。</p>

<p><strong>二级工厂（Second level factory）</strong></p>

<p>对于数据库工厂，情况并非如此。 因为我们需要每个数据服务同时支持多个数据库，所以需要二级工厂，这意味着对于每种数据服务类型，例如“UserDataService”，我们需要为每个支持的数据库使用单独的工厂。 现在，由于有两个数据库，我们需要两个工厂。</p>

<p><img src="/images/userDataServiceFactory.jpg" alt="userDataServiceFactory" /></p>

<p>你可以从上面的图像中看到，我们需要四个文件来完成“UserDataService”，其中“userDataServiceFactoryWrapper.go”是在“userdataservicefactory”文件夹中调用实际工厂的封装器（wrapper）。 “couchdbUserDataServiceFactory.go”和“sqlUserDataServiceFactory.go”是CouchDB和MySql数据库的真正工厂。 “userDataServiceFactory.go”定义了接口。 如果你有许多数据服务，那么你将创建许多类似代码。</p>

<p><strong>简化工厂（Simplified factory）</strong></p>

<p>有没有办法简化它？ 有的，这是第三种方式，但也带来一些问题。 以下是“courseDataServiceFactory.go”的代码。 你可以看到只需一个文件而不是之前的四个文件。 代码类似于我们刚才谈到的“userDataServiceFactory”。那么它是如何如何简化代码的呢？</p>

<p>关键是为底层数据库链接创建统一的接口。 在“courseDataServiceFactory.go”中，可以在调用“dataStoreFactory”之后获得底层数据库链接统一接口，并将“CourseDataServiceInterface”的DB设置为正确的“gdbc”（只要它实现“gdbc”接口，它可以是任何数据库链接）。</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">courseDataServiceMap</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#a6e22e">dataservice</span>.<span style="color:#a6e22e">CourseDataInterface</span>{
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">COUCHDB</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">couchdb</span>.<span style="color:#a6e22e">CourseDataCouchdb</span>{},
	<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">SQLDB</span>:   <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">sqldb</span>.<span style="color:#a6e22e">CourseDataSql</span>{},
}

<span style="color:#75715e">// courseDataServiceFactory is an empty receiver for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">courseDataServiceFactory</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#75715e">// GetCourseDataServiceInterface is an accessor for factoryBuilderMap
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GetCourseDataServiceInterface</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#a6e22e">dataservice</span>.<span style="color:#a6e22e">CourseDataInterface</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">courseDataServiceMap</span>[<span style="color:#a6e22e">key</span>]
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tdsf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">courseDataServiceFactory</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">dataConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DataConfig</span>) (<span style="color:#a6e22e">DataServiceInterface</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">dsc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dataConfig</span>.<span style="color:#a6e22e">DataStoreConfig</span>
	<span style="color:#a6e22e">dsi</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">datastorefactory</span>.<span style="color:#a6e22e">GetDataStoreFb</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">Code</span>).<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">dsc</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	}
	<span style="color:#a6e22e">gdbc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dsi</span>.(<span style="color:#a6e22e">gdbc</span>.<span style="color:#a6e22e">Gdbc</span>)
	<span style="color:#a6e22e">gdi</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">GetCourseDataServiceInterface</span>(<span style="color:#a6e22e">dsc</span>.<span style="color:#a6e22e">Code</span>)
	<span style="color:#a6e22e">gdi</span>.<span style="color:#a6e22e">SetDB</span>(<span style="color:#a6e22e">gdbc</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">gdi</span>, <span style="color:#66d9ef">nil</span>
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p>它的缺点是，对于任何支持的数据库，需要实现以下代码中“SqlGdbc”和“NoSqlGdbc”接口，即使它只使用其中一个，另一个只是空实现（以满足接口要求）并没有被使用。 如果你只有少数几个数据库需要支持，这可能是一个可行的解决方案，否则它将变得越来越难以管理。</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// SqlGdbc (SQL Go database connection) is a wrapper for SQL database handler 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SqlGdbc</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Exec</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) (<span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Result</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Prepare</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Stmt</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Query</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) (<span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Rows</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">QueryRow</span>(<span style="color:#a6e22e">query</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#f92672">...</span><span style="color:#66d9ef">interface</span>{}) <span style="color:#f92672">*</span><span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">Row</span>
	<span style="color:#75715e">// If need transaction support, add this interface
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Transactioner</span>
}

<span style="color:#75715e">// NoSqlGdbc (NoSQL Go database connection) is a wrapper for NoSql database handler.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">NoSqlGdbc</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#75715e">// The method name of underline database was Query(), but since it conflicts with the name with Query() in SqlGdbc,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// so have to change to a different name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">QueryNoSql</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">ddoc</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">view</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Rows</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">docID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">doc</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Options</span>) (<span style="color:#a6e22e">rev</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">docID</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Options</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Row</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">Find</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">query</span> <span style="color:#66d9ef">interface</span>{}) (<span style="color:#f92672">*</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Rows</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">AllDocs</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">options</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Options</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">kivik</span>.<span style="color:#a6e22e">Rows</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// gdbc is an unified way to handle database connections. 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Gdbc</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">SqlGdbc</span>
	<span style="color:#a6e22e">NoSqlGdbc</span>
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p>除了上面谈到的那个之外，还有另一个副作用。 在下面的代码中，“CourseDataInterface”中的“SetDB”函数打破了依赖关系。 因为“CourseDataInterface”是数据服务层接口，所以它不应该依赖于“gdbc”接口，这是下面一层的接口。 这是本程序的依赖关系中的第二个缺陷，第一个是在<a href="https://jfeng45.github.io/posts/transaction_support/">事物管理</a>⁶模块。 目前对它没有好的解决方法，如果你不喜欢它，就不要使用它。 可以创建类似于“userFataServiceFactory”的二级工厂，只是程序较长而已。</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;github.com/jfeng45/servicetmpl/model&#34;</span>
	<span style="color:#e6db74">&#34;github.com/jfeng45/servicetmpl/tool/gdbc&#34;</span>
)

<span style="color:#75715e">// CourseDataInterface represents interface for persistence service for course data
</span><span style="color:#75715e">// It is created for POC of courseDataServiceFactory, no real use.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CourseDataInterface</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">FindAll</span>() ([]<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Course</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">SetDB</span>(<span style="color:#a6e22e">gdbc</span> <span style="color:#a6e22e">gdbc</span>.<span style="color:#a6e22e">Gdbc</span>)
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p><strong>怎样选择?</strong></p>

<p>怎样选择是用简化工厂还是二级工厂？这取决于变化的方向。如果你需要支持大量新数据库，但新的数据服务不多（由新的域模型类型决定），那么选二级工厂，因为大多数更改都会发生在数据存储工厂中。但是如果支持的数据库不会发生太大变化，并且数据服务的数量可能会增加很多，那么选择简化工厂。如果两者都可能增加很多呢？那么只能使用二级工厂，只是程序会比较长。</p>

<p>怎样选择使用基本工厂还是二级工厂？实际上，即使你需要支持多个数据库，但不需<strong>同时</strong>支持多个数据库，你仍然可以使用基本工厂。例如，你需要从MySQL切换到MongoDB，即使有两个不同的数据库，但在切换后，你只使用MongoDB，那么你仍然可以使用基本工厂。对于基本工厂，当有多种类型时，你需要更改代码以进行切换（但对于二级工厂，你只需更改配置文件），因此如果你不经常更改代码，这是可以忍受的。</p>

<h5 id="依赖注入-dependency-injection-库"><strong>依赖注入（Dependency Injection）库</strong></h5>

<p><br/></p>

<p>Go中已经有几个依赖注入库，为什么我不使用它们？我有意在项目初期时不使用任何库，所以我可以更好地控制程序结构，只有在完成整个程序结构布局之后，我才会考虑用外部库替换本程序的某些组件。</p>

<p>我简要地看了几个流行的依赖注入库，一个是来自<a href="https://blog.drewolson.org/dependency-injection-in-go">优步</a>⁷的<a href="https://github.com/uber-go/dig">Dig</a>⁸，另一个是来自<a href="https://github.com/google/wire">谷歌</a>¹⁰的<a href="https://blog.drewolson.org/go-dependency-injection-with-wire">Wire</a>⁹ 。 Dig使用反射，Wire使用代码生成。这两种方法我都不喜欢，但由于Go目前不支持泛型，因此这些是唯一可用的选项。虽然我不喜欢他们的方法，但我不得不承认这两个库的依赖注入功能更全。</p>

<p>我试了一下Dig，发现它没有使代码更简单，所以我决定继续使用当前的解决方案。在Dig中，你为每个具体类型创建“（build）”函数，然后将其注册到容器，最后容器将它们自动连接在一起以创建顶级类型。本程序的复杂性是因为我们需要支持两个数据库实现，因此每个域模型有两个不同的数据库链接和两组不同的数据服务实现。在Dig中没有办法使这部分更简单，你仍然需要创建所有工厂然后把它们注册到容器。当然，你可以使用“if-else”方法来实现工厂，这将使代码更简单，但你以后需要付出更多努力来维护代码。</p>

<p>我的方法简单易用，并且还支持从文件加载配置，但是你需要了解它的原理以扩展它。 Dig提供的附加功能是自动加载依赖关系。如果你的应用程序有很多类型并且类型之间有很多复杂的依赖关系，那么你可能需要切换到Dig或Wire，否则请继续使用当前的解决方案</p>

<h5 id="接口设计"><strong>接口设计</strong></h5>

<p><br/>
下面是 “userDataServiceFactoryWrapper”的代码.</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// DataServiceInterface serves as a marker to indicate the return type for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">DataServiceInterface</span> <span style="color:#66d9ef">interface</span>{}

<span style="color:#75715e">// userDataServiceFactory is a empty receiver for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">userDataServiceFactoryWrapper</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">udsfw</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">userDataServiceFactoryWrapper</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">dataConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DataConfig</span>) 
    (<span style="color:#a6e22e">DataServiceInterface</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">key</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dataConfig</span>.<span style="color:#a6e22e">DataStoreConfig</span>.<span style="color:#a6e22e">Code</span>
	<span style="color:#a6e22e">udsi</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">userdataservicefactory</span>.<span style="color:#a6e22e">GetUserDataServiceFb</span>(<span style="color:#a6e22e">key</span>).<span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">dataConfig</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">udsi</span>, <span style="color:#66d9ef">nil</span>
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p>你可能注意到了“Build（）”函数的返回类型是“DataServiceInterface”，这是一个空接口，为什么我们需要一个空接口？ 我们可以用“interface {}”替换“DataServiceInterface”吗？</p>

<p><div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// userDataServiceFactory is a empty receiver for Build method
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">userDataServiceFactoryWrapper</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">udsfw</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">userDataServiceFactoryWrapper</span>) <span style="color:#a6e22e">Build</span>(<span style="color:#a6e22e">c</span> <span style="color:#a6e22e">container</span>.<span style="color:#a6e22e">Container</span>, <span style="color:#a6e22e">dataConfig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">DataConfig</span>) 
    (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
<span style="color:#f92672">...</span>
}</code></pre></td></tr></table>
</div>
</div>
<br/></p>

<p>如果将返回类型从“DataServiceInterface”替换为“interface {}”，结果是相同的。 “DataServiceInterface”的好处是它可以告诉我函数的返回类型，即数据服务接口; 实际上，真正的返回类型是“dataservice.UserDataInterface”，但是“DataStoreInterface”现在已经足够好了，一个小诀窍让生活变得轻松一点。</p>

<h5 id="结论"><strong>结论:</strong></h5>

<p>程序容器使用依赖注入创建具体类型并将它们注入每个函数。 它的核心是工厂方法模式。 在Go中有三种方法可以实现它，最好的方法是在映射（map）中保存不同的工厂。 将工厂方法模式应用于数据服务层也有不同的方法，它们各自都有利有弊。 你需要根据应用程序的更改方向选择正确的方法。</p>

<h5 id="源程序"><strong>源程序:</strong></h5>

<p>完整的源程序链接 <a href="https://github.com/jfeng45/servicetmpl">github</a>: <a href="https://github.com/jfeng45/servicetmpl">https://github.com/jfeng45/servicetmpl</a></p>

<h5 id="其他文章"><strong>其他文章:</strong></h5>

<p>请在这里阅读本系列的其他文章 “<a href="https://jfeng45.github.io/posts/clean_architecture_with_go/">清晰架构（Clean Architecture）的Go微服务</a>”.</p>

<h5 id="索引"><strong>索引:</strong></h5>

<p>[1]<a href="https://jfeng45.github.io/posts/application_container/">Go Microservice with Clean Architecture: Application Container</a></p>

<p>[2] <a href="https://www.martinfowler.com/articles/injection.html#FormsOfDependencyInjection">Inversion of Control Containers and the Dependency Injection pattern</a></p>

<p>[3]]<a href="https://stackoverflow.com/a/49714445">Golang Factory Method</a></p>

<p>[4]<a href="https://stackoverflow.com/questions/3434466/creating-a-factory-method-in-java-that-doesnt-rely-on-if-else">Creating a factory method in Java that doesn’t rely on if-else</a></p>

<p>[5]<a href="https://stackoverflow.com/questions/3434466/creating-a-factory-method-in-java-that-doesnt-rely-on-if-else/3434505#3434505">Tom Hawtin’s answer</a></p>

<p>[6]<a href="https://jfeng45.github.io/posts/transaction_support/">Go Microservice with Clean Architecture: Transaction Support</a></p>

<p>[7]<a href="https://blog.drewolson.org/dependency-injection-in-go">Dependency Injection in Go</a></p>

<p>[8]<a href="https://github.com/uber-go/dig">Uber’s dig</a></p>

<p>[9]<a href="https://blog.drewolson.org/go-dependency-injection-with-wire">Go Dependency Injection with Wire</a></p>

<p>[10]<a href="https://github.com/google/wire">Google’s Wire: Automated Initialization in Go</a></p>


    
      <h4>翻译</h4>
      <ul>
        
        <li>
          <a href="/en/posts/dependency_injection/">en: Go Microservice with Clean Architecture: Dependency Injection</a>
        </li>
        
      </ul>
    

    

    <h4>相关文章</h4>
    <ul>
        
            <li><a href="/posts/application_container/">清晰架构（Clean Atchitecture）的Go微服务: 程序容器（Application Container）</a></li>
        
            <li><a href="/posts/coding_style/">清晰架构（Clean Architecture）的Go微服务: 编码风格</a></li>
        
            <li><a href="/posts/transaction_support/">清晰架构（Clean Atchitecture）的Go微服务: 事物管理</a></li>
        
            <li><a href="/posts/clean_architecture_with_go/">清晰架构（Clean Architecture）的Go微服务</a></li>
        
            <li><a href="/posts/clean_architecture_application_design/">清晰架构（Clean Architecture）的Go微服务: 程序设计</a></li>
        
    </ul>

    <div id="disqus_thread"></div>
<script type="text/javascript">

    (function() {
        
        
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        var disqus_shortname = 'jfeng45';
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>



          </div>

          <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
        


<section>
    <h4>最新文章</h4>
    <ol class="list-unstyled">
        
        <li>
            <a href="/posts/dependency_injection/">依赖注入</a>
        </li>
        
        <li>
            <a href="/posts/application_container/">程序容器</a>
        </li>
        
        <li>
            <a href="/posts/go_logging_and_error_handling/">日志管理和错误处理</a>
        </li>
        
        <li>
            <a href="/posts/coding_style/">编码风格</a>
        </li>
        
        <li>
            <a href="/posts/transaction_support/">事物管理</a>
        </li>
        
        <li>
            <a href="/posts/clean_architecture_with_go/">Go微服务系列(*****)</a>
        </li>
        
        <li>
            <a href="/posts/clean_architecture_application_design/">清晰架构设计</a>
        </li>
        
        <li>
            <a href="/posts/clean_architecture_design_principle/">设计原则</a>
        </li>
        
        <li>
            <a href="/posts/go_microservice_application_layout/">Go微服务程序结构</a>
        </li>
        
    </ol>
</section>

    
    
        <section>
    
        
        <h4>分类</h4>
        <p>
            
            <a class="badge badge-primary" href="/categories/go%E5%BE%AE%E6%9C%8D%E5%8A%A1">go微服务</a>
            
        </p>
        
    
        
        <h4>标签</h4>
        <p>
            
            <a class="badge badge-primary" href="/tags/golang">golang</a>
            
            <a class="badge badge-primary" href="/tags/grpc">grpc</a>
            
            <a class="badge badge-primary" href="/tags/%E4%BA%8B%E7%89%A9%E7%AE%A1%E7%90%86">事物管理</a>
            
            <a class="badge badge-primary" href="/tags/%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5">依赖注入</a>
            
            <a class="badge badge-primary" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1">微服务</a>
            
            <a class="badge badge-primary" href="/tags/%E6%97%A5%E5%BF%97%E7%AE%A1%E7%90%86">日志管理</a>
            
            <a class="badge badge-primary" href="/tags/%E6%B8%85%E6%99%B0%E6%9E%B6%E6%9E%84">清晰架构</a>
            
            <a class="badge badge-primary" href="/tags/%E7%A8%8B%E5%BA%8F%E5%AE%B9%E5%99%A8">程序容器</a>
            
            <a class="badge badge-primary" href="/tags/%E7%A8%8B%E5%BA%8F%E7%BB%93%E6%9E%84">程序结构</a>
            
            <a class="badge badge-primary" href="/tags/%E7%BC%96%E7%A0%81%E9%A3%8E%E6%A0%BC">编码风格</a>
            
            <a class="badge badge-primary" href="/tags/%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">错误处理</a>
            
        </p>
        
    
</section>
    
</aside>

        </div>
      </div>
      
    </div>
    <div id="footer">
      
        







<footer class="blog-footer-bs w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Powered by Hugo | Theme - Bootstrap</p>
        <p class="w-100 text-center"><a href="#">回到头部</a></p>
    </nav>
</footer>

      
    </div>
    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </div>
  </body>
</html>
